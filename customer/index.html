<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processamento de Pagamento - PIX</title>
    
    <!-- Cor de Tema do Navegador -->
    <meta name="theme-color" content="#0b6ef7">

    <!-- FAVICONS E ÍCONES -->
    <link rel="icon" href="images/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="images/favicon-96x96.png" type="image/png" sizes="96x96">
    
    <!-- Nosso CSS -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Font Awesome para ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        /* Garantir que .hidden funcione */
        .hidden {
            display: none !important;
        }
        
        /* Melhorias visuais para loading */
        .initial-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            text-align: center;
            color: var(--color-text-secondary);
        }
        
        .initial-loading .spinner {
            display: block;
            margin-bottom: 1rem;
        }
        
        /* Progresso do polling */
        .polling-progress {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--color-text-muted);
        }
        
        /* Alerta de validação */
        .validation-alert {
            background-color: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
   <main class="page">
    <div class="container">
        <!-- ESTADO DE CARREGAMENTO INICIAL -->
        <div id="initial-loading" class="initial-loading">
            <div class="spinner"></div>
            <p>Carregando dados do seu pedido...</p>
            <small style="color: #9ca3af; margin-top: 0.5rem;">Por favor, aguarde</small>
        </div>

        <!-- ESTADO DE ERRO (SEM HASH) -->
        <div id="no-hash-error" class="error-state hidden">
            <div class="error-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2>Pedido não encontrado</h2>
            <p>Não conseguimos localizar seus dados. Por favor, inicie seu pedido novamente ou entre em contato com o suporte.</p>
            <a id="redirect-to-checkout" class="btn btn--primary" href="/checkout/">
                <i class="fas fa-arrow-left"></i>
                Voltar para o Checkout
            </a>
        </div>

        <!-- ESTADO DE ERRO (HASH INVÁLIDO) -->
        <div id="invalid-hash-error" class="error-state hidden">
            <div class="error-icon">
                <i class="fas fa-times-circle"></i>
            </div>
            <h2>Link inválido</h2>
            <p>O código de identificação do pedido está incorreto. Verifique o link recebido ou solicite um novo.</p>
            <a class="btn btn--primary" href="/checkout/">
                <i class="fas fa-arrow-left"></i>
                Voltar para o Checkout
            </a>
        </div>

        <!-- CONTEÚDO PRINCIPAL (INICIALMENTE ESCONDIDO) -->
        <div id="main-content" class="hidden">
            <!-- Alerta de validação (se necessário) -->
            <div id="validation-alert" class="validation-alert hidden">
                <i class="fas fa-info-circle"></i>
                <span id="validation-message"></span>
            </div>
            
            <header class="page-header">
                <div class="page-header__info">
                    <span class="page-header__label">Pedido:</span>
                    <span id="orderIdDisplay" class="page-header__value">—</span>
                </div>
                <div class="page-header__info">
                    <span class="page-header__label">Valor:</span>
                    <span id="amountLabel" class="page-header__value">R$ 0,00</span>
                </div>
            </header>

            <section class="pix-section">
                <div class="pix-code">
                    <input id="pixKey" class="pix-code__input" readonly aria-label="Código PIX (copia e cola)" placeholder="Carregando código PIX..." />
                    <div id="copiedMsgTop" class="pix-code__msg" role="status" aria-live="polite">Código copiado para área de transferência ✅</div>
                    <button id="copyPrimary" class="btn btn--primary" disabled>
                        <i class="fa-regular fa-copy"></i> Copiar código (PIX Copia e Cola)
                    </button>
                </div>

                <div class="qr-container" aria-hidden="false">
                    <img id="qrImage" class="qr-container__image" alt="QR Code PIX" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Crect fill='%23f0f0f0' width='260' height='260'/%3E%3Ctext x='50%25' y='50%25' fill='%23999' text-anchor='middle' dy='.3em' font-family='Arial' font-size='14'%3ECarregando QR Code...%3C/text%3E%3C/svg%3E" />
                    <div class="qr-container__expires">
                        <span>Expira em: </span>
                        <span id="countdown">10:00</span>
                    </div>
                </div>
            </section>

            <section class="instructions-section">
                <h2 class="instructions-section__title">Como pagar com PIX:</h2>
                <ol class="instructions-section__list">
                    <li>Abra o app do seu banco</li>
                    <li>Escolha pagar com PIX</li>
                    <li>Escaneie o QR Code ou cole o código</li>
                </ol>
            </section>

            <div class="status-container">
                <div id="spinner" class="spinner" aria-hidden="true"></div>
                <div class="status-box" aria-live="polite" aria-atomic="true" role="status">
                    <h3 id="statusTitle" class="status-box__title" tabindex="-1">Aguardando pagamento...</h3>
                    <p id="statusMessage" class="status-box__message">Estamos processando seu pagamento</p>
                    <p id="pollingProgress" class="polling-progress hidden"></p>
                    <div id="copiedMsgStatus" class="pix-code__msg" role="status" aria-live="polite" style="display:none">Código copiado para área de transferência ✅</div>
                </div>
            </div>

            <div class="actions">
                <a id="openAppBtn" class="btn btn--ghost" href="#" target="_blank" rel="noopener" role="button" aria-label="Abrir no aplicativo">
                    <i class="fa-solid fa-arrow-up-right-from-square"></i>
                    Abrir no app
                </a>
                <button id="confirmBtn" class="btn btn--confirm">Confirmar pagamento</button>
            </div>

            <div class="raw-pix-section">
                <label for="pixRaw" class="raw-pix-section__label">Código PIX Cópia e Cola</label>
                <textarea id="pixRaw" class="raw-pix-section__textarea" rows="3" readonly placeholder="O código PIX aparecerá aqui..."></textarea>
            </div>
        </div>
    </div>
</main>

    <footer>
        <div class="footer-content">
            <!-- Seção 1: Suporte e Contato -->
            <section class="footer__section footer__support">
                <div class="support-info">
                    <img src="https://placehold.co/200x200/741b75/FFF?font=montserrat&text=AG" alt="Logo do Suporte Avalia" class="support-icon">
                    <span>Suporte</span>
                </div>
                <p>Em caso de dúvidas, entre em contato:</p>
                <a href="mailto:contato@checkout.site" class="footer__link">
                    <i class="fas fa-envelope"></i> contato@checkout.site
                </a>
            </section>

            <!-- Seção 2: Segurança e Confiança -->
            <section class="footer__section footer__trust">
                <p class="footer__security-notice">
                    <i class="fas fa-shield-alt"></i> Site 100% seguro
                </p>
                <div class="reclame-aqui-badge">
                    <a href="#" target="_blank" title="Confira nossa reputação no Reclame Aqui">
                        <div class="badge-content">
                            <img src="https://s3.amazonaws.com/raichu-beta/selos/assets/images/ra-1000.svg" alt="Selo RA 1000 Reclame Aqui" class="badge-icon">
                            <div class="badge-text">
                                <p>RA 1000</p>
                                <span>Reclame <strong>AQUI</strong></span>
                            </div>
                        </div>
                    </a>
                </div>
            </section>

            <!-- Seção 3: Informações Legais e Avisos -->
            <section class="footer__section footer__legal">
                <p class="terms">
                    Checkout está processando este pedido à serviço de Suporte Avalia. Ao prosseguir você está concordando com os termos de uso.
                </p>
                <div class="legal-notices">
                    <p class="security-notice">
                        <i class="fas fa-lock"></i> Pagamento 100% seguro, processado com criptografia.
                    </p>
                    <p class="product-notice">
                        <i class="fas fa-info-circle"></i> Produto digital, os dados para acesso serão enviados por email.
                    </p>
                </div>
            </section>
        </div>
    </footer>

    <!-- SCRIPTS MOVIDOS PARA O FINAL DO BODY - OTIMIZAÇÃO DE PERFORMANCE -->
    <!-- Script de Rastreamento UTM -->
    <script>
    // trakiefy-latest.js v1.0.0 - Seu Utmify 100% grátis e melhor que o original
    document.addEventListener("DOMContentLoaded", () => {
      const keys = ['utm_source','utm_medium','utm_campaign','utm_content','utm_term','gclid','fbclid','ttclid','xcod','sck','src','click_id','cid'];
      const storage = localStorage;
      const expDays = 7 * 24 * 60 * 60 * 1000; // 7 dias

      // 1. Salva todos os parâmetros que chegaram na URL
      new URLSearchParams(location.search).forEach((value, key) => {
        if (keys.includes(key)) {
          storage.setItem(key, value);
          storage.setItem(key + '_exp', Date.now() + expDays);
        }
      });

      // 2. Codifica xcod/sck com caracteres invisíveis
      const encodeInvisible = (str) => str.replace(/[0-9a-f]/gi, c => String.fromCharCode(8203 + parseInt(c, 16)));

      // 3. Restaura UTM em todos os links + injeta xcod/sck no WhatsApp
      const restoreLinks = () => {
        document.querySelectorAll('a[href]').forEach(link => {
          if (!link.href || link.href.includes('mailto:') || link.href.includes('#')) return;

          try {
            const url = new URL(link.href);

            // Restaura UTM normais
            keys.forEach(key => {
              const val = storage.getItem(key);
              const exp = storage.getItem(key + '_exp');
              if (val && exp && Date.now() < +exp) {
                url.searchParams.set(key, val);
              }
            });

            // WhatsApp: injeta xcod/sck codificado no campo text
            if (url.hostname.includes('wa.me') || url.hostname.includes('api.whatsapp.com') || url.hostname.includes('chat.whatsapp.com')) {
              const clickId = storage.getItem('xcod') || storage.getItem('sck') || '';
              if (clickId) {
                const encoded = encodeInvisible(clickId);
                const currentText = url.searchParams.get('text') || 'Olá';
                url.searchParams.set('text', currentText + ' ' + encoded);
              }
            }

            link.href = url.toString();
          } catch (e) {}
        });
      };

      // Executa agora + sempre que mudar o DOM
      restoreLinks();
      new MutationObserver(restoreLinks).observe(document.body, { childList: true, subtree: true });
      setTimeout(restoreLinks, 1500);
      setTimeout(restoreLinks, 4000);
    });
    </script>
    <script src="js/script.js"></script>
</body>
</html>
